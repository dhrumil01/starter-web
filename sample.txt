code from master branch
some merge toold changes



